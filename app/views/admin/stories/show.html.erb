<div class="card card-outline card-primary shadow">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="card-title font-weight-bold mb-0">Kiểm duyệt: <%= @story.title %></h3>
    <span class="badge badge-pill <%= 'badge-warning' if @story.pending? %> <%= 'badge-success' if @story.approved? %> <%= 'badge-danger' if @story.rejected? %> px-3 py-2">
      TRẠNG THÁI HIỆN TẠI: <%= @story.status.upcase %>
    </span>
  </div>

  <div class="card-body">
    <div class="row">
      <div class="col-md-6 border-right">
        <label class="text-muted small">CÂU CHUYỆN</label>
        <p class="lead"><%= @story.definition %></p>
      </div>
      <div class="col-md-6">
        <label class="text-muted small">VÍ DỤ</label>
        <p class="lead"><%= @story.example %></p>
      </div>
    </div>
  </div>

  <div class="card-footer bg-light">
    <div class="row align-items-center">
      <div class="col-md-3">
        <% unless @story.approved? %>
          <%= button_to approve_admin_story_path(@story), method: :patch, class: "btn btn-success btn-block elevation-2" do %>
            <i class="fas fa-check-circle"></i> CHUYỂN THÀNH DUYỆT
          <% end %>
        <% end %>
      </div>

      <div class="col-md-9">
        <%= form_with url: reject_admin_story_path(@story), method: :patch, class: "d-flex" do |f| %>
          <div class="input-group">
            <%= f.text_field :rejection_reason,
                             class: "form-control",
                             placeholder: "Nhập lý do từ chối (bắt buộc nếu Reject)...",
                             value: @story.rejection_reason,
                             required: true %>
            <div class="input-group-append">
              <button type="submit" class="btn btn-danger font-weight-bold">
                <i class="fas fa-times-circle"></i> TỪ CHỐI BÀI NÀY
              </button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<div class="mt-3">
  <%= link_to admin_stories_path, class: "text-muted" do %>
    <i class="fas fa-arrow-left"></i> Quay lại danh sách
  <% end %>
</div>
<hr>
<div class="card mt-4 shadow-none border">
  <div class="card-header bg-light">
    <h3 class="card-title text-secondary font-weight-bold">
      <i class="fas fa-history mr-1"></i> Lịch sử kiểm duyệt (Audit Log)
    </h3>
  </div>
  <div class="card-body p-0">
    <table class="table table-sm mb-0">
      <thead class="thead-light">
      <tr>
        <th>Thời gian</th>
        <th>Người thực hiện</th>
        <th>Hành động</th>
        <th>Lý do / Ghi chú</th>
      </tr>
      </thead>
      <tbody>
      <% if @story.review_audit_logs.any? %>
        <% @story.review_audit_logs.order(created_at: :desc).each do |log| %>
          <tr>
            <td><%= log.created_at.strftime("%H:%M - %d/%m/%Y") %></td>
            <td><span class="text-muted"><%= log.admin.email %></span></td>
            <td>
                <span class="badge <%= log.action == 'approve' ? 'badge-success' : 'badge-danger' %>">
                  <%= log.action.upcase %>
                </span>
            </td>
            <td><small><%= log.reason || "Không có ghi chú" %></small></td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="4" class="text-center text-muted py-3">Chưa có lịch sử duyệt cho bài này.</td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>