<style>
    /* --- CSS CHO SLIDING MODAL --- */
    .modal-dialog { transition: max-width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); max-width: 500px; }
    .modal-dialog.expanded { max-width: 1100px; /* Rộng hơn chút để xem câu hỏi thoải mái */ }

    .sliding-container { display: flex; overflow: hidden; background: #fff; border-radius: 0.35rem; }

    .info-panel {
        min-width: 500px; width: 500px; z-index: 10; background: #fff;
        display: flex; flex-direction: column;
    }

    .list-panel {
        width: 0; opacity: 0; visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        background: #f8f9fc; border-left: 1px solid #e3e6f0;
        display: flex; flex-direction: column; flex-grow: 1;
    }

    .modal-dialog.expanded .list-panel { width: 600px; opacity: 1; visibility: visible; }

    .question-list-scroll { overflow-y: auto; max-height: 550px; }

    /* --- INFO ROW STYLE --- */
    .info-row {
        padding: 12px 0;
        border-bottom: 1px solid #eaecf4;
        display: flex; align-items: center;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { width: 40%; color: #858796; font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value { width: 60%; color: #5a5c69; font-weight: 700; font-size: 0.95rem; }
</style>

<div class="d-flex justify-content-between mb-4 align-items-center">
  <h1 class="h3 text-gray-800 border-left-primary pl-3">Quản lý Đề Thi</h1>
  <%= link_to new_admin_exam_path, class: "btn btn-primary btn-icon-split shadow-sm" do %>
    <span class="icon text-white-50"><i class="fas fa-plus"></i></span>
    <span class="text font-weight-bold">Tạo Đề Thi Mới</span>
  <% end %>
</div>

<div class="card shadow mb-4">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-striped mb-0" width="100%" cellspacing="0">
        <thead class="thead-light">
        <tr>
          <th class="text-center" width="5%">ID</th>
          <th width="35%">Tên Đề Thi</th>
          <th width="15%">Loại</th>
          <th class="text-center">Thời gian</th>
          <th class="text-center">Số câu</th>
          <th class="text-center" width="15%">Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <% if @exams.empty? %>
          <tr><td colspan="6" class="text-center py-5 text-muted">Chưa có dữ liệu đề thi.</td></tr>
        <% else %>
          <% @exams.each do |exam| %>
            <tr>
              <td class="text-center align-middle font-weight-bold text-gray-600">#<%= exam['id'] %></td>
              <td class="align-middle font-weight-bold text-primary" style="font-size: 1rem;"><%= exam['name'] %></td>
              <td class="align-middle">
                <% badge_class, type_name = case exam['type']
                                            when 'MINI' then ['badge-info', 'Mini Exam']
                                            when 'SKIBIDI' then ['badge-warning', 'Skibidi Exam']
                                            when 'SUPER' then ['badge-danger', 'Super Exam']
                                            when 'ENTRANCE' then ['badge-success', 'Entrance Exam']
                                            else ['badge-secondary', 'N/A']
                                            end %>
                <span class="badge <%= badge_class %> px-2 py-1"><%= type_name %></span>
              </td>
              <td class="text-center align-middle font-weight-bold text-gray-700"><%= exam['duration'] %> phút</td>
              <td class="text-center align-middle font-weight-bold"><%= exam['total_questions'] || exam['totalQuestions'] || 0 %></td>

              <td class="text-center align-middle">
                <div class="btn-group shadow-sm">
                  <button type="button" class="btn btn-sm btn-info" onclick="openModal('<%= exam['id'] %>')" title="Xem chi tiết">
                    <i class="fas fa-eye"></i>
                  </button>
                  <%= link_to edit_admin_exam_path(exam['id']), class: "btn btn-sm btn-warning", title: "Sửa" do %><i class="fas fa-edit"></i><% end %>
                  <%= button_to admin_exam_path(exam['id']), method: :delete, class: "btn btn-sm btn-danger", onclick: "return confirm('Bạn có chắc chắn muốn xóa?')", title: "Xóa" do %><i class="fas fa-trash"></i><% end %>
                </div>
              </td>
            </tr>

            <div class="modal fade" id="modalExam<%= exam['id'] %>" tabindex="-1" role="dialog" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" id="dialog-<%= exam['id'] %>" role="document">
                <div class="modal-content border-0 shadow-lg overflow-hidden">

                  <div class="modal-header bg-primary text-white py-3">
                    <h5 class="modal-title font-weight-bold mx-auto"><i class="fas fa-file-alt mr-2"></i>Chi tiết Đề thi #<%= exam['id'] %></h5>
                    <button type="button" class="close text-white position-absolute" style="right: 15px;" data-dismiss="modal"><span>&times;</span></button>
                  </div>

                  <div class="modal-body p-0">
                    <div class="sliding-container">

                      <div class="info-panel p-4">
                        <div class="text-center mb-4">
                          <h4 class="text-primary font-weight-bold mb-1"><%= exam['name'] %></h4>
                          <span class="badge <%= badge_class %> px-3 py-2 mt-2" style="font-size: 0.9rem;"><%= type_name %></span>
                        </div>

                        <div class="px-3">
                          <div class="info-row">
                            <div class="info-label"><i class="far fa-clock mr-2"></i>Thời gian</div>
                            <div class="info-value"><%= exam['duration'] %> phút</div>
                          </div>
                          <div class="info-row">
                            <div class="info-label"><i class="fas fa-check-double mr-2"></i>Điểm đậu</div>
                            <div class="info-value text-success"><%= exam['pass_score'] || exam['passScore'] %> điểm</div>
                          </div>
                          <% if exam['target_rank'] || exam['targetRank'] %>
                            <div class="info-row">
                              <div class="info-label"><i class="fas fa-medal mr-2"></i>Rank mục tiêu</div>
                              <div class="info-value font-weight-bold text-warning">
                                <%= exam['target_rank'] || exam['targetRank'] %>
                              </div>
                            </div>
                          <% end %>
                          <div class="info-row">
                            <div class="info-label"><i class="fas fa-list-ol mr-2"></i>Số câu hỏi</div>
                            <div class="info-value"><%= exam['total_questions'] || exam['totalQuestions'] %> câu</div>
                          </div>
                          <div class="info-row">
                            <div class="info-label"><i class="fas fa-toggle-on mr-2"></i>Trạng thái</div>
                            <div class="info-value">
                              <%= exam['status'] == 1 ? '<span class="text-success"><i class="fas fa-circle text-xs mr-1"></i>Hoạt động</span>'.html_safe : '<span class="text-secondary"><i class="fas fa-circle text-xs mr-1"></i>Đang ẩn</span>'.html_safe %>
                            </div>
                          </div>
                          <div class="info-row">
                            <div class="info-label"><i class="far fa-calendar-plus mr-2"></i>Ngày tạo</div>
                            <div class="info-value small">
                              <% created = exam['created_at'] || exam['createdAt'] || exam['createAt'] %>
                              <%= created ? DateTime.parse(created).strftime("%H:%M - %d/%m/%Y") : raw("<span class='text-muted font-italic'>--</span>") %>
                            </div>
                          </div>
                          <div class="info-row">
                            <div class="info-label"><i class="far fa-calendar-check mr-2"></i>Ngày sửa</div>
                            <div class="info-value small">
                              <% updated = exam['updated_at'] || exam['updatedAt'] || exam['updateAt'] %>
                              <%= updated ? DateTime.parse(updated).strftime("%H:%M - %d/%m/%Y") : raw("<span class='text-muted font-italic'>--</span>") %>
                            </div>
                          </div>
                        </div>

                        <div class="mt-auto pt-4">
                          <button type="button" class="btn btn-outline-primary btn-block btn-lg toggle-btn shadow-sm font-weight-bold" onclick="toggleList('<%= exam['id'] %>', this)">
                            Xem danh sách câu hỏi <i class="fas fa-chevron-right ml-2"></i>
                          </button>
                        </div>
                      </div>

                      <div class="list-panel">
                        <%
                          list_questions = exam['full_questions'] || exam['fullQuestions'] || []
                          count = list_questions.size
                        %>
                        <div class="p-3 bg-white border-bottom d-flex justify-content-between align-items-center shadow-sm" style="z-index: 5;">
                          <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-layer-group mr-2"></i>Ngân hàng câu hỏi</h6>
                          <span class="badge badge-pill badge-primary px-3 py-2"><%= count %> câu</span>
                        </div>

                        <div class="question-list-scroll p-3 bg-light">
                          <% if count > 0 %>
                            <% list_questions.each_with_index do |q, index| %>
                              <div class="card mb-3 border-0 shadow-sm question-card">
                                <div class="card-body p-3">
                                  <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                      <span class="badge badge-info mr-2">Câu <%= index + 1 %></span>
                                      <% type = q['question_type'] || q['questionType'] %>
                                      <span class="badge badge-light border text-muted"><%= type %></span>
                                    </div>
                                  </div>

                                  <p class="mb-2 font-weight-bold text-dark" style="font-size: 1rem; line-height: 1.5;">
                                    <%= q['question_text'] || q['questionText'] %>
                                  </p>

                                  <% answer = q['correct_answer'] || q['correctAnswer'] %>
                                  <% if answer %>
                                    <div class="p-2 rounded bg-success-light text-success font-weight-bold border border-success" style="background-color: #e6fffa; font-size: 0.9rem;">
                                      <i class="fas fa-check-circle mr-1"></i> Đáp án: <%= answer %>
                                    </div>
                                  <% end %>
                                </div>
                              </div>
                            <% end %>
                          <% else %>
                            <div class="text-center py-5 text-gray-500">
                              <i class="fas fa-folder-open fa-3x mb-3 text-gray-300"></i><br>
                              Chưa có dữ liệu câu hỏi chi tiết.
                            </div>
                          <% end %>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
    function openModal(id) {
        $('#dialog-' + id).removeClass('expanded');
        $('.toggle-btn').html('Xem danh sách câu hỏi <i class="fas fa-chevron-right ml-2"></i>').removeClass('btn-primary text-white').addClass('btn-outline-primary');
        $('#modalExam' + id).modal('show');
    }

    function toggleList(id, btn) {
        const dialog = document.getElementById('dialog-' + id);
        const $btn = $(btn);

        if (dialog.classList.contains('expanded')) {
            dialog.classList.remove('expanded');
            $btn.html('Xem danh sách câu hỏi <i class="fas fa-chevron-right ml-2"></i>');
            $btn.removeClass('btn-primary text-white').addClass('btn-outline-primary');
        } else {
            dialog.classList.add('expanded');
            $btn.html('<i class="fas fa-chevron-left mr-2"></i> Thu gọn danh sách');
            $btn.removeClass('btn-outline-primary').addClass('btn-primary text-white');
        }
    }
</script>