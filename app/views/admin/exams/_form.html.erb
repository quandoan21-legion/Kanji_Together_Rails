<%= form_with scope: :exam, url: url, method: method, local: true do |f| %>

  <div class="row">
    <div class="col-md-5">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-info-circle"></i> Thông tin Đề Thi</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Tên Đề Thi <span class="text-danger">*</span></label>
            <%= f.text_field :name, value: @exam['name'], class: "form-control", required: true, placeholder: "VD: Đề thi thử N5 - Số 1" %>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="form-group">
                <label>Loại Đề</label>
                <%= f.select :exam_type,
                             options_for_select([
                                                  ['Đầu vào (Entrance)', 'ENTRANCE_EXAM'],
                                                  ['Kiểm tra bài học (Mini)', 'MINI_EXAM'],
                                                  ['Thi thử (Mock)', 'MOCK_TEST']
                                                ], @exam['examType']), {}, class: "form-control" %>
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label>Rank Mục Tiêu</label>
                <%= f.select :target_rank,
                             options_for_select(['UNRANKED', 'N5', 'N4', 'N3', 'N2', 'N1'], @exam['targetRank']), {}, class: "form-control" %>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="form-group">
                <label>Thời gian (Phút)</label>
                <%= f.number_field :duration, value: @exam['duration'] || 45, class: "form-control" %>
              </div>
            </div>
            <div class="col-6">
              <div class="form-group">
                <label>Điểm Đậu</label>
                <%= f.number_field :pass_score, value: @exam['passScore'] || 50, class: "form-control" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-7">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list-ol"></i> Chọn Câu Hỏi</h5>
          <span class="badge badge-light text-dark" id="question-count">0 đã chọn</span>
        </div>

        <div class="card-body p-0">
          <div class="p-2 border-bottom bg-light">
            <input type="text" id="search-question" class="form-control form-control-sm" placeholder="Gõ để lọc câu hỏi...">
          </div>

          <div style="height: 400px; overflow-y: auto;" class="p-2">
            <%
              # Lấy ID các câu hỏi đã có trong đề (để check sẵn)
              # Java trả về mảng object [{id:1}, {id:2}], ta map ra [1, 2]
              selected_q_ids = (@exam['questions'] || []).map { |q| q['id'] }
            %>

            <% if @questions && @questions.any? %>
              <% @questions.each do |q| %>
                <div class="custom-control custom-checkbox border-bottom py-2 question-item">
                  <%= check_box_tag "exam[question_ids][]", q['id'], selected_q_ids.include?(q['id']),
                                    class: "custom-control-input question-checkbox", id: "q_#{q['id']}" %>

                  <label class="custom-control-label w-100" for="q_<%= q['id'] %>" style="cursor: pointer;">
                    <span class="badge badge-secondary mr-1"><%= q['question_type'] %></span>
                    <span class="font-weight-bold text-dark"><%= truncate(q['question_text'], length: 60) %></span>
                    <br>
                    <small class="text-muted">
                      Đáp án: <span class="text-success"><%= q['correct_answer'] %></span>
                      <% if q['related_kanjis'].present? %>
                        | Kanji: <%= q['related_kanjis'].map{|k| k['kanji']}.join(", ") %>
                      <% end %>
                    </small>
                  </label>
                </div>
              <% end %>
            <% else %>
              <div class="text-center py-5 text-muted">
                Chưa có câu hỏi nào trong ngân hàng.<br>
                <%= link_to "Thêm câu hỏi ngay", new_admin_question_path %>
              </div>
            <% end %>
          </div>
        </div>

        <div class="card-footer text-right bg-white">
          <%= link_to "Hủy", admin_exams_path, class: "btn btn-secondary mr-2" %>
          <%= f.submit "Lưu Đề Thi", class: "btn btn-primary px-4" %>
        </div>
      </div>
    </div>
  </div>

<% end %>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const checkboxes = document.querySelectorAll('.question-checkbox');
        const countBadge = document.getElementById('question-count');
        const searchInput = document.getElementById('search-question');
        const items = document.querySelectorAll('.question-item');

        // 1. Hàm đếm số lượng đang chọn
        function updateCount() {
            const checkedCount = document.querySelectorAll('.question-checkbox:checked').length;
            countBadge.innerText = checkedCount + " đã chọn";
        }

        // Gắn sự kiện click
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateCount);
        });

        // Gọi lần đầu
        updateCount();

        // 2. Hàm lọc tìm kiếm
        searchInput.addEventListener('keyup', function() {
            const term = this.value.toLowerCase();

            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                if (text.includes(term)) {
                    item.classList.remove('d-none');
                } else {
                    item.classList.add('d-none');
                }
            });
        });
    });
</script>