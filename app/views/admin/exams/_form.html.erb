<%= form_tag(@exam['id'] ? admin_exam_path(@exam['id']) : admin_exams_path, method: @exam['id'] ? :put : :post, id: "examForm") do %>

  <div class="row no-gutters mt-3">
    <%# C·ªòT TR√ÅI: C·∫§U H√åNH (ƒê√É TH√äM KHUNG R√ï R√ÄNG) %>
    <div class="col-lg-4 pr-lg-3">
      <%# ƒê·ªïi border-0 th√†nh border-dark ƒë·ªÉ hi·ªán khung card %>
      <div class="card shadow-sm border-dark mb-4">
        <div class="card-header py-3 bg-dark text-white border-0">
          <h6 class="m-0 font-weight-bold text-center text-uppercase" style="letter-spacing: 1px;">Th√¥ng s·ªë ƒë·ªÅ thi</h6>
        </div>
        <div class="card-body p-4 bg-white">
          <div class="form-group mb-4">
            <label class="label-mini">T√™n ƒê·ªÅ Thi <span class="text-danger">*</span></label>
            <%# B·ªè c√°c class x√≥a border (border-top-0, v.v.) ƒë·ªÉ hi·ªán khung h·ªôp %>
            <input type="text" name="name" class="form-control border-dark px-2" value="<%= @exam['name'] %>" required placeholder="Nh·∫≠p t√™n ƒë·ªÅ...">
          </div>

          <div class="form-group mb-4">
            <label class="label-mini">Lo·∫°i ƒê·ªÅ Thi</label>
            <select name="type" id="examTypeSelector" class="custom-select rounded-pill font-weight-bold text-primary border-dark">
              <option value="MINI" <%= 'selected' if @exam['type'] == 'MINI' %>>Mini Exam (10 c√¢u - 12p)</option>
              <option value="SKIBIDI" <%= 'selected' if @exam['type'] == 'SKIBIDI' %>>Skibidi Exam (30 c√¢u - 35p)</option>
              <option value="SUPER" <%= 'selected' if @exam['type'] == 'SUPER' %>>Super Exam (60 c√¢u - 60p)</option>
              <option value="ENTRANCE" <%= 'selected' if @exam['type'] == 'ENTRANCE' %>>Entrance Exam (50 c√¢u - 50p)</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group col-md-6">
              <label class="label-mini">Th·ªùi gian (ph√∫t)</label>
              <input type="number" name="duration" id="durationInput"
                     class="form-control pill-input bg-white text-center font-weight-bold border-dark"
                     value="<%= @exam['duration'] %>">
            </div>
            <div class="form-group col-md-6">
              <label class="label-mini">ƒêi·ªÉm ƒë·∫≠u</label>
              <input type="number" name="pass_score" id="passScoreInput"
                     class="form-control pill-input bg-white text-center font-weight-bold border-dark"
                     value="<%= @exam['pass_score'] %>">
            </div>
          </div>

          <div class="form-group mb-4">
            <label class="label-mini">C·∫•p ƒë·ªô m·ª•c ti√™u (Target Rank)</label>
            <select name="target_rank" class="custom-select rounded-pill border-dark">
              <option value="">-- M·∫∑c ƒë·ªãnh --</option>
              <% ['N1', 'N2', 'N3', 'N4', 'N5'].each do |lvl| %>
                <option value="<%= lvl %>" <%= 'selected' if @exam['target_rank'] == lvl %>><%= lvl %></option>
              <% end %>
            </select>
          </div>

          <div class="form-group mb-5">
            <label class="label-mini">Tr·∫°ng th√°i ph√°t h√†nh</label>
            <select name="status" class="custom-select rounded-pill border-dark">
              <option value="1" <%= 'selected' if @exam['status'] == 1 %>>‚úÖ Ho·∫°t ƒë·ªông</option>
              <option value="0" <%= 'selected' if @exam['status'] == 0 %>>üö´ ƒêang ·∫©n</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary btn-block rounded-pill font-weight-bold py-3 shadow-sm mb-2">
            <i class="fas fa-save mr-2"></i> L∆ØU ƒê·ªÄ THI
          </button>
          <%= link_to "H·ªßy b·ªè", admin_exams_path, class: "btn btn-link btn-block text-muted small" %>
        </div>
      </div>
    </div>

    <%# C·ªòT PH·∫¢I: NG√ÇN H√ÄNG C√ÇU H·ªéI %>
    <div class="col-lg-8">
      <%# ƒê·ªïi border-0 th√†nh border-dark %>
      <div class="card shadow-sm border-dark" style="height: 750px; display: flex; flex-direction: column;">
        <div class="card-header py-3 bg-white d-flex justify-content-between align-items-center border-bottom">
          <div id="questionCounter" class="badge-smart">
            ƒê√£ ch·ªçn: <span class="current">0</span> / <span class="max">10</span>
          </div>
          <%# ƒê·ªïi border-0 th√†nh border-dark %>
          <input type="text" id="quickSearch" class="form-control form-control-sm w-50 rounded-pill bg-light border-dark px-3" placeholder="üîç T√¨m ki·∫øm nhanh c√¢u h·ªèi...">
        </div>

        <div class="card-body p-0 flex-grow-1 custom-scroll" style="overflow-y: auto;">
          <table class="table table-fixed m-0" id="questionsTable">
            <thead class="bg-light sticky-top shadow-sm text-center">
            <tr>
              <th style="width: 70px;">ID</th>
              <th style="width: 70px;">
                <div class="custom-control custom-checkbox d-inline-block">
                  <input type="checkbox" class="custom-control-input" id="checkAllQuestions">
                  <label class="custom-control-label" for="checkAllQuestions"></label>
                </div>
              </th>
              <th class="text-left">N·ªôi dung c√¢u h·ªèi</th>
              <th style="width: 140px;">Lo·∫°i c√¢u</th>
            </tr>
            </thead>
            <tbody>
            <% selected_ids = @exam['question_ids'] || [] %>
            <% @all_questions.each do |q| %>
              <tr class="q-row <%= 'table-primary' if selected_ids.include?(q['id']) %>">
                <td class="text-center align-middle font-weight-bold text-muted border-right">#<%= q['id'] %></td>
                <td class="text-center align-middle border-right">
                  <div class="custom-control custom-checkbox d-inline-block">
                    <input type="checkbox" name="question_ids[]" value="<%= q['id'] %>"
                           class="custom-control-input question-checkbox" id="q_<%= q['id'] %>"
                           <%= 'checked' if selected_ids.include?(q['id']) %>>
                    <label class="custom-control-label" for="q_<%= q['id'] %>"></label>
                  </div>
                </td>
                <td class="align-middle px-3">
                  <div class="wrap-text font-weight-bold text-dark"><%= q['question_text'] %></div>
                  <div class="small text-success mt-1 font-italic"><i class="fas fa-check-circle mr-1"></i><%= q['correct_answer'] %></div>
                </td>
                <td class="text-center align-middle border-left">
                  <span class="badge-type"><%= q['question_type'] %></span>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<% end %>

<style>
    /* √âP KHUNG CHO CARD */
    .card.border-dark { border: 1px solid #343a40 !important; }

    /* √âP KHUNG ƒê·∫¨M CHO T·∫§T C·∫¢ INPUT V√Ä SELECT */
    .form-control.border-dark,
    .custom-select.border-dark,
    .pill-input.border-dark {
        border: 1px solid #343a40 !important;
    }

    .table-fixed { table-layout: fixed; width: 100%; }
    .align-middle { vertical-align: middle !important; }
    .text-center { text-align: center !important; }

    .wrap-text {
        white-space: normal;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.5;
        display: block;
        width: 100%;
    }

    /* Vi·ªÅn d∆∞·ªõi cho Header b·∫£ng ƒë·ªÉ t√°ch bi·ªát r√µ r√†ng */
    .sticky-top {
        top: 0;
        z-index: 1020;
        background: #f8f9fa;
        border-bottom: 2px solid #343a40 !important;
    }

    .label-mini { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #333; letter-spacing: 0.5px; margin-bottom: 5px; }

    .badge-smart { background: #fff3cd; color: #856404; padding: 6px 20px; border-radius: 50px; font-weight: bold; border: 1px solid #343a40; }
    .badge-type { background: #e1f5fe; color: #0288d1; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; border: 1px solid #0288d1; }

    .custom-control-label::before { border: 1px solid #343a40 !important; }
</style>

<%# C√°c script JS gi·ªØ nguy√™n 100% %>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const checkAll = document.getElementById('checkAllQuestions');
        const checkboxes = document.querySelectorAll('.question-checkbox');
        const counterSpan = document.querySelector('#questionCounter .current');

        function updateCounter() {
            const count = document.querySelectorAll('.question-checkbox:checked').length;
            if (counterSpan) counterSpan.innerText = count;
        }

        if (checkAll) {
            checkAll.addEventListener('change', function() {
                checkboxes.forEach(cb => {
                    const row = cb.closest('tr');
                    cb.checked = this.checked;
                    if (cb.checked) row.classList.add('table-primary');
                    else row.classList.remove('table-primary');
                });
                updateCounter();
            });
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', function() {
                const row = this.closest('tr');
                if (this.checked) row.classList.add('table-primary');
                else row.classList.remove('table-primary');
                updateCounter();
            });
        });
        updateCounter();
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const typeSelect = document.getElementById('examTypeSelector');
        const durationInput = document.getElementById('durationInput');
        const passScoreInput = document.getElementById('passScoreInput');

        const EXAM_RULES = {
            'MINI':     { duration: 12, pass: 8 },
            'SKIBIDI':  { duration: 35, pass: 21 },
            'SUPER':    { duration: 60, pass: 36 },
            'ENTRANCE': { duration: 50, pass: 40 }
        };

        function updateConfig() {
            const type = typeSelect.value;
            const rule = EXAM_RULES[type];
            if (rule) {
                durationInput.value = rule.duration;
                passScoreInput.value = rule.pass;
            }
        }
        typeSelect.addEventListener('change', updateConfig);
        if (typeSelect.value) { updateConfig(); }
    });
</script>