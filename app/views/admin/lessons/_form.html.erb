<%# app/views/admin/lessons/_form.html.erb %>

<style>
    /* 1. KHUNG CUỘN DANH SÁCH */
    .kanji-scroll-box {
        height: 450px;
        overflow-y: auto;
        border: 1px solid #e3e6f0;
        background: #f8f9fc;
        padding: 15px;
        border-radius: 8px;
    }

    /* Tùy chỉnh thanh cuộn cho đẹp */
    .kanji-scroll-box::-webkit-scrollbar { width: 8px; }
    .kanji-scroll-box::-webkit-scrollbar-track { background: #f1f1f1; }
    .kanji-scroll-box::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    .kanji-scroll-box::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

    /* 2. THẺ KANJI (ITEM) */
    .kanji-card-label {
        display: block;
        cursor: pointer;
        margin-bottom: 0;
        position: relative;
    }

    /* Ẩn checkbox gốc đi nhưng vẫn giữ logic check */
    .kanji-checkbox {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    /* Giao diện thẻ Kanji */
    .kanji-card-content {
        display: flex;
        align-items: center;
        background: white;
        border: 2px solid #e3e6f0; /* Viền xám nhạt */
        border-radius: 8px;
        padding: 10px;
        transition: all 0.2s ease-in-out;
    }

    /* Hiệu ứng khi di chuột */
    .kanji-card-label:hover .kanji-card-content {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        border-color: #4e73df; /* Màu xanh khi hover */
    }

    /* Khi checkbox được check -> đổi màu thẻ content ngay lập tức */
    .kanji-checkbox:checked + .kanji-card-content {
        background-color: #e8f0fe; /* Nền xanh nhạt */
        border-color: #4e73df;     /* Viền xanh đậm */
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25); /* Hiệu ứng glow */
    }

    /* Đổi màu chữ Kanji khi chọn */
    .kanji-checkbox:checked + .kanji-card-content .kanji-char {
        color: #4e73df !important;
        transform: scale(1.1);
    }
</style>

<%= form_with url: url, method: method, local: true, id: "lesson-form" do |f| %>

  <div class="row">
    <%# --- CỘT TRÁI: NỘI DUNG CHÍNH --- %>
    <div class="col-lg-8">
      <div class="card shadow mb-4">
        <div class="card-header py-3 bg-primary">
          <h6 class="m-0 font-weight-bold text-white">Thông tin bài học</h6>
        </div>
        <div class="card-body">

          <%# TÊN BÀI HỌC %>
          <div class="form-group mb-4">
            <label class="font-weight-bold text-dark">Tên bài học <span class="text-danger">*</span></label>
            <%= f.text_field :kanji, value: @lesson["kanji"], class: "form-control form-control-lg", placeholder: "Ví dụ: Bài 1, Chủ đề Gia đình...", required: true %>
          </div>

          <%# KHUNG CHỌN KANJI %>
          <div class="form-group">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="font-weight-bold text-primary mb-0"><i class="fas fa-layer-group mr-1"></i>Chọn Kanji</label>
              <span class="badge badge-primary px-3 py-2" id="count-badge">0 chữ</span>
            </div>

            <%# Ô TÌM KIẾM NHANH %>
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text bg-light border-0"><i class="fas fa-search text-gray-500"></i></span>
              </div>
              <input type="text" id="quick-search" class="form-control bg-light border-0 small" placeholder="Tìm nhanh Kanji (nhập chữ cái, âm on/kun, nghĩa...)" aria-label="Search">
            </div>

            <%# LIST KANJI %>
            <div class="kanji-scroll-box">
              <div class="row" id="kanji-grid">
                <% if @active_kanjis.any? %>
                  <%
                    # Lấy danh sách ID đã có để check sẵn
                    current_ids = @lesson["kanji_ids"]&.map(&:to_i) || []
                  %>

                  <% @active_kanjis.each do |k| %>
                    <% is_selected = current_ids.include?(k["id"].to_i) %>

                    <div class="col-md-6 mb-3 kanji-item" data-filter="<%= k['kanji'].downcase %> <%= k['translation']&.downcase %> <%= k['hanViet']&.downcase %> n<%= k['jlpt'] %>">
                      <label class="kanji-card-label">
                        <%# CHECKBOX ẨN %>
                        <input type="checkbox"
                               class="kanji-checkbox"
                               name="kanji_ids[]"
                               value="<%= k['id'] %>"
                               <%= 'checked' if is_selected %>>

                        <%# GIAO DIỆN THẺ (Sẽ đổi màu dựa theo checkbox ở trên) %>
                        <div class="kanji-card-content">
                          <div class="mr-3">
                            <span class="kanji-char font-weight-bold text-secondary" style="font-size: 2rem; transition: 0.2s;">
                              <%= k["kanji"] %>
                            </span>
                          </div>
                          <div class="flex-grow-1" style="line-height: 1.2;">
                            <div class="font-weight-bold text-dark"><%= k["translation"] %></div>
                            <div class="small text-muted mt-1">
                              <span class="badge badge-light border">N<%= k["jlpt"] %></span>
                              <%= truncate(k["meaning"] || k["mean"], length: 20) %>
                            </div>
                          </div>
                          <%# Dấu tích xanh (Chỉ hiện khi chọn - dùng CSS) %>
                          <div class="check-icon text-primary ml-2" style="display: none;">
                            <i class="fas fa-check-circle fa-lg"></i>
                          </div>
                        </div>
                      </label>
                    </div>
                  <% end %>
                <% else %>
                  <div class="col-12 text-center text-muted py-5">
                    <i class="fas fa-inbox fa-3x mb-3 text-gray-300"></i><br>
                    Chưa có dữ liệu Kanji nào.
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <%# MÔ TẢ %>
          <div class="form-group mt-4">
            <label class="font-weight-bold text-dark">Mô tả nội dung</label>
            <%= f.text_area :lesson_description, value: @lesson["lesson_description"], class: "form-control", rows: 4, placeholder: "Nhập ghi chú cho bài học..." %>
          </div>

        </div>
      </div>
    </div>

    <%# --- CỘT PHẢI: CÀI ĐẶT --- %>
    <div class="col-lg-4">
      <div class="card shadow mb-4">
        <div class="card-header py-3 bg-success">
          <h6 class="m-0 font-weight-bold text-white">Thiết lập</h6>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="font-weight-bold">Trình độ JLPT</label>
            <%= f.select :jlpt, options_for_select([['N5', 5], ['N4', 4], ['N3', 3], ['N2', 2], ['N1', 1]], @lesson["jlpt"]), {}, { class: "form-control custom-select" } %>
          </div>

          <div class="form-group">
            <label class="font-weight-bold">Trạng thái</label>
            <%= f.select :status, options_for_select([['Hoạt động', 'ACTIVE'], ['Đã ẩn', 'HIDDEN']], @lesson["status"] || 'ACTIVE'), {}, { class: "form-control custom-select" } %>
          </div>

          <hr>

          <button type="submit" class="btn btn-primary btn-block btn-lg font-weight-bold shadow-sm">
            <i class="fas fa-save mr-2"></i>Lưu Bài Học
          </button>

          <%= link_to admin_lessons_path, class: "btn btn-secondary btn-block" do %>
            <i class="fas fa-times mr-2"></i>Hủy bỏ
          <% end %>
        </div>
      </div>
    </div>
  </div>

<% end %>

<style>
    .kanji-checkbox:checked + .kanji-card-content .check-icon {
        display: block !important;
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. TÌM KIẾM NHANH (Fast Search)
        const searchInput = document.getElementById('quick-search');
        const items = document.querySelectorAll('.kanji-item');

        if(searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                const term = e.target.value.toLowerCase().trim();

                items.forEach(item => {
                    // Lấy từ khóa tìm kiếm đã gán sẵn trong data-filter
                    const keywords = item.getAttribute('data-filter');
                    if (keywords.includes(term)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // 2. ĐẾM SỐ LƯỢNG (Live Counter)
        const checkboxes = document.querySelectorAll('.kanji-checkbox');
        const badge = document.getElementById('count-badge');

        function updateCounter() {
            const count = document.querySelectorAll('.kanji-checkbox:checked').length;
            badge.innerText = count + " chữ";

            // Đổi màu badge nếu có chọn
            if(count > 0) {
                badge.classList.remove('badge-secondary');
                badge.classList.add('badge-primary');
            } else {
                badge.classList.add('badge-secondary');
                badge.classList.remove('badge-primary');
            }
        }

        // Gán sự kiện click cho tất cả checkbox
        checkboxes.forEach(cb => cb.addEventListener('change', updateCounter));

        // Chạy 1 lần khi load trang để đếm số lượng đang có
        updateCounter();
    });
</script>