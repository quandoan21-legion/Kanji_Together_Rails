<%# 1. Khởi tạo giá trị mặc định %>
<% @errors ||= {} %>
<% @kanji ||= {} %>
<% is_edit = @kanji["id"].present? %>
<%# Đảm bảo @lock_core_fields luôn có giá trị để không bị lỗi readonly %>
<% @lock_core_fields ||= false %>

<% if @errors.any? %>
  <div class="alert alert-danger shadow-sm mb-4">
    <h5 class="alert-heading font-weight-bold">
      <i class="fas fa-exclamation-triangle mr-2"></i> Có lỗi xảy ra:
    </h5>
    <hr>
    <ul class="mb-0 pl-3">
      <% @errors.each do |field, msg| %>
        <% if msg.present? %>
          <li><strong><%= field.to_s.humanize %>:</strong> <%= msg %></li>
        <% end %>
      <% end %>
    </ul>
  </div>
<% end %>

<%= form_with scope: :kanji,
              url: (is_edit ? admin_kanji_path(@kanji["id"]) : admin_kanjis_path),
              method: (is_edit ? :put : :post),
              local: true,
              data: { turbo: false },
              html: { class: "needs-validation", novalidate: true, id: "kanji-form" } do |f| %>

  <div class="card card-body shadow-sm">
    <h5 class="text-primary font-weight-bold border-bottom pb-2">Thông tin cơ bản</h5>
    <div class="row">
      <div class="col-md-3 form-group">
        <label>Chữ Kanji <span class="text-danger">*</span></label>
        <%= f.text_field :kanji, value: @kanji["kanji"],
                         class: "form-control form-control-lg text-center font-weight-bold #{'is-invalid' if @errors['kanji']}",
                         placeholder: "VD: 休",
                         readonly: @lock_core_fields %>
        <% if @errors['kanji'] %>
          <div class="invalid-feedback d-block"><i class="fas fa-exclamation-circle"></i> <%= @errors["kanji"] %></div>
        <% end %>
      </div>

      <div class="col-md-3 form-group">
        <label>Hán Việt <span class="text-danger">*</span></label>
        <%# FIX: Xóa oninput, dùng class text-uppercase để gõ được tiếng Việt %>
        <%= f.text_field :translation,
                         value: @kanji["translation"],
                         id: "kanji_translation",
                         class: "form-control form-control-lg text-uppercase font-weight-bold #{'is-invalid' if @errors['translation']}",
                         placeholder: "VD: ÚC, UẤT",
                         readonly: @lock_core_fields %>
        <% if @errors['translation'] %>
          <div class="invalid-feedback d-block"><%= @errors["translation"] %></div>
        <% end %>
      </div>

      <div class="col-md-3 form-group">
        <label>Cấp độ JLPT <span class="text-danger">*</span></label>
        <%= f.select :jlpt, options_for_select((1..5).reverse_each.map{|i| ["N#{i}", i]}, @kanji["jlpt"]), { include_blank: "-- Chọn --" },
                     class: "form-control form-control-lg #{'is-invalid' if @errors['jlpt']}" %>
        <% if @errors['jlpt'] %>
          <div class="invalid-feedback d-block"><%= @errors["jlpt"] %></div>
        <% end %>
      </div>

      <div class="col-md-3 form-group">
        <label>Trạng thái</label>
        <%= f.select :status,
                     options_for_select([
                                          ["Công khai (ACTIVE)", "ACTIVE"],
                                          ["Đã ẩn (HIDDEN)", "HIDDEN"]
                                        ], @kanji["status"] || "ACTIVE"),
                     {},
                     class: "form-control form-control-lg shadow-sm border-primary" %>
      </div>

      <div class="col-md-12 form-group">
        <label>Nghĩa Tiếng Việt <span class="text-danger">*</span></label>
        <%= f.text_field :meaning, value: @kanji["meaning"],
                         class: "form-control #{'is-invalid' if @errors['meaning']}",
                         placeholder: "Nhập nghĩa..." %>
        <% if @errors['meaning'] %>
          <div class="invalid-feedback d-block"><%= @errors["meaning"] %></div>
        <% end %>
      </div>
    </div>

    <h5 class="text-primary font-weight-bold border-bottom pb-2 mt-3">Âm & Cách viết</h5>
    <div class="row">
      <div class="col-md-6 form-group">
        <label>Onyomi (Âm On - Katakana <span class="text-danger">*</span>)</label>
        <%= f.text_area :on_pronunciation, value: @kanji["on_pronunciation"], rows: 3,
                        class: "form-control #{'is-invalid' if @errors['on_pronunciation']}",
                        placeholder: "VD: キュウ" %>
      </div>

      <div class="col-md-6 form-group">
        <label>Kunyomi (Âm Kun - Hiragana <span class="text-danger">*</span>)</label>
        <%= f.text_area :kun_pronunciation, value: @kanji["kun_pronunciation"], rows: 3,
                        class: "form-control #{'is-invalid' if @errors['kun_pronunciation']}",
                        placeholder: "VD: やす.む" %>
      </div>

      <div class="col-md-4 form-group">
        <label>Số nét <span class="text-danger">*</span></label>
        <%= f.number_field :num_strokes, value: @kanji["num_strokes"],
                           class: "form-control #{'is-invalid' if @errors['num_strokes']}" %>
      </div>

      <div class="col-md-8 form-group">
        <label>URL ảnh cách viết (GIF/SVG <span class="text-danger">*</span>)</label>
        <%= f.text_field :writing_image_url, value: @kanji["writing_image_url"],
                         class: "form-control #{'is-invalid' if @errors['writing_image_url']}",
                         placeholder: "https://..." %>
      </div>
    </div>

    <h5 class="text-primary font-weight-bold border-bottom pb-2 mt-3">Chi tiết bổ sung</h5>
    <div class="row">
      <div class="col-md-6 form-group">
        <label>Bộ thủ (Radical <span class="text-danger">*</span>)</label>
        <%= f.text_field :radical, value: @kanji["radical"],
                         class: "form-control #{'is-invalid' if @errors['radical']}",
                         placeholder: "VD: 鬯 SƯỞNG" %>
      </div>

      <div class="col-md-6 form-group">
        <label>Bộ thành phần (Components - Tùy chọn)</label>
        <%= f.text_field :components, value: @kanji["components"],
                         class: "form-control",
                         placeholder: "VD: 亻 Nhân, 木 Mộc" %>
      </div>

      <div class="col-md-12 form-group">
        <label>Câu chuyện ghi nhớ <span class="text-danger">*</span></label>
        <%= f.text_area :kanji_description, value: @kanji["kanji_description"], rows: 2,
                        class: "form-control #{'is-invalid' if @errors['kanji_description']}" %>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6 form-group">
        <label>Từ vựng (Vocabulary)</label>
        <%= f.text_area :vocabulary, value: @kanji["vocabulary"], rows: 4,
                        class: "form-control #{'is-invalid' if @errors['vocabulary']}",
                        placeholder: "[NHẬT]-[PHIÊN ÂM]-[NGHĨA]" %>
      </div>
      <div class="col-md-6 form-group">
        <label>Ví dụ (Examples)</label>
        <%= f.text_area :examples, value: @kanji["examples"], rows: 4,
                        class: "form-control #{'is-invalid' if @errors['examples']}",
                        placeholder: "[CÂU NHẬT]-[DỊCH VIỆT]" %>
      </div>
    </div>

    <div class="mt-4 border-top pt-3 text-center">
      <button type="submit" id="btn-submit" class="btn btn-primary btn-lg px-5 shadow">
        <i class="fas fa-save mr-1"></i> LƯU KANJI
      </button>
      <%= link_to "Hủy bỏ", admin_kanjis_path, class: "btn btn-outline-secondary btn-lg ml-2" %>
    </div>
  </div>
<% end %>

<script>
    // FIX: Tự động viết hoa khi RỜI KHỎI ô (blur) để không làm hỏng bộ gõ tiếng Việt
    document.addEventListener("DOMContentLoaded", function() {
        var translationInput = document.getElementById("kanji_translation");
        if (translationInput) {
            translationInput.addEventListener("blur", function() {
                this.value = this.value.toUpperCase();
            });
        }
    });

    // Hiệu ứng nút Submit
    document.getElementById("kanji-form").addEventListener("submit", function(e) {
        var btn = document.getElementById("btn-submit");
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
        btn.classList.add("disabled");
        btn.style.pointerEvents = "none";
    });
</script>