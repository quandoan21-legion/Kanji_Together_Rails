<style>
    /* 1. CĂN CHỈNH CONTAINER */
    .content-wrapper, .main-content, .content { padding-top: 0 !important; margin-top: 0 !important; }
    .content-header { display: none !important; }
    .container-fluid {
        padding-top: 10px !important;
        margin-top: 0 !important;
        padding-bottom: 20px !important;
    }

    /* 2. THANH TÌM KIẾM */
    .search-container {
        background: #f8f9fa;
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 20px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    /* 3. BẢNG DỮ LIỆU */
    .custom-kanji-table th, .custom-kanji-table td {
        font-size: 1.05rem;
        vertical-align: middle !important;
    }
    .kanji-display {
        font-size: 2.3rem;
        line-height: 1;
        font-weight: bold;
        color: #007bff;
    }

    /* 4. NÚT TRÒN */
    .btn-circle {
        width: 34px; height: 34px; border-radius: 50%;
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0; transition: all 0.2s;
    }

    /* 5. PHÂN TRANG */
    .pagination-wrapper {
        display: flex; justify-content: center; width: 100%;
    }
    .custom-pagination-bar {
        display: inline-flex; gap: 6px; background: #fff; border-radius: 999px;
        padding: 8px 15px; border: 1px solid #dee2e6;
    }
    .custom-pagination-bar a, .custom-pagination-bar span {
        min-width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;
        border-radius: 50%; font-size: 0.9rem; font-weight: 600; text-decoration: none;
    }
</style>

<div class="container-fluid">
  <div class="row mb-4 align-items-center">
    <div class="col-sm-6">
      <h3 class="m-0 text-dark font-weight-bold">
        <i class="fas fa-torii-gate text-primary mr-2"></i>Quản lý Kanji
      </h3>
    </div>
    <div class="col-sm-6 text-right">
      <%= link_to new_admin_kanji_path, class: "btn btn-success shadow-sm rounded-pill px-4 font-weight-bold" do %>
        <i class="fas fa-plus-circle mr-1"></i> Thêm Kanji Mới
      <% end %>
    </div>
  </div>

  <%# --- THANH TÌM KIẾM --- %>
  <div class="search-container shadow-sm mb-4">
    <%= form_with url: admin_kanjis_path, method: :get, local: true, class: "form-inline" do |f| %>

      <%# 1. LỌC TRẠNG THÁI %>
      <div class="input-group input-group-sm mr-2 mb-2 mb-sm-0">
        <div class="input-group-prepend">
          <label class="input-group-text bg-white border-right-0 font-weight-bold text-muted">Loại</label>
        </div>
        <%= f.select :status,
                     options_for_select([['-- Tất cả --', ''], ['Hoạt động', 'ACTIVE'], ['Chờ duyệt', 'PENDING'], ['Đã ẩn', 'HIDDEN'], ['Đã duyệt', 'APPROVED'], ['Đã từ chối', 'REJECTED']], params[:status]),
                     {}, { class: "form-control border-left-0 custom-select", onchange: "this.form.submit()" } %>
      </div>

      <%# 2. LỌC NGÀY THÁNG (MỚI THÊM) %>
      <div class="input-group input-group-sm mr-2 mb-2 mb-sm-0">
        <div class="input-group-prepend">
          <label class="input-group-text bg-white border-right-0 font-weight-bold text-muted">
            <i class="far fa-calendar-alt mr-1"></i> Ngày
          </label>
        </div>
        <%# date_field sẽ hiện lịch khi bấm vào %>
        <%= f.date_field :created_at, value: params[:created_at], class: "form-control border-left-0", style: "max-width: 160px;", onchange: "this.form.submit()" %>
      </div>

      <%# 3. TÌM KIẾM TỪ KHÓA %>
      <div class="input-group input-group-sm flex-grow-1" style="max-width: 400px;">
        <%= f.text_field :keyword, value: params[:keyword], class: "form-control", placeholder: "Tìm kiếm Kanji, nghĩa, Hán việt..." %>
        <div class="input-group-append">
          <button class="btn btn-primary px-3 font-weight-bold" type="submit">Tìm</button>
        </div>
      </div>
    <% end %>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3">
      <h5 class="card-title font-weight-bold text-dark mb-0">
        <i class="fas fa-list-ul mr-1 text-primary"></i> Danh sách Kanji
      </h5>
    </div>

    <div class="card-body table-responsive p-0">
      <table class="table table-hover table-bordered mb-0 custom-kanji-table">
        <thead class="bg-light text-center text-uppercase small font-weight-bold">
        <tr>
          <th width="70px">ID</th>
          <th width="110px">Kanji</th>
          <th>Thông tin cơ bản</th>
          <th width="90px">JLPT</th>
          <th width="160px">Trạng thái</th>
          <th width="180px">Thao tác</th>
        </tr>
        </thead>
        <tbody>
        <% if @kanjis.any? %>
          <% @kanjis.each do |k| %>
            <%
              status = k["status"].to_s.upcase
              is_active = k["is_active"]
              is_contribution = ['PENDING', 'REJECTED', 'APPROVED'].include?(status)
            %>
            <tr>
              <td class="text-center text-muted font-weight-bold">#<%= k["id"] %></td>
              <td class="text-center <%= 'click-detail' unless is_contribution %>" style="<%= 'cursor: pointer;' unless is_contribution %>" onclick="<%= "showKanjiDetail(#{k.to_json})" unless is_contribution %>">
                <span class="kanji-display"><%= k["kanji"] %></span>
              </td>
              <td class="px-3">
                <div class="font-weight-bold">Hán Việt: <span class="text-danger text-uppercase"><%= k["han_viet"] || k["translation"] %></span></div>
                <div class="text-muted small mt-1"><%= truncate(k["meaning"], length: 65) %></div>
              </td>
              <td class="text-center"><span class="badge badge-info px-2 py-1 shadow-xs">N<%= k["jlpt"] %></span></td>
              <td class="text-center">
                <%
                  if status == 'PENDING' then badge_class, badge_text = 'badge-warning text-white', 'Chờ duyệt'
                  elsif status == 'APPROVED' then badge_class, badge_text = 'badge-info', 'Đã duyệt'
                  elsif status == 'REJECTED' then badge_class, badge_text = 'badge-danger', 'Đã từ chối'
                  elsif status == 'HIDDEN' || is_active == false || is_active.to_s == 'false' then badge_class, badge_text = 'badge-secondary', 'Đã ẩn'
                  else badge_class, badge_text = 'badge-success', 'Hoạt động'
                  end
                %>
                <span class="badge <%= badge_class %> p-2 shadow-sm" style="min-width: 90px;"><%= badge_text %></span>
              </td>
              <td class="text-center">
                <div class="d-flex justify-content-center align-items-center">
                  <% unless is_contribution %>
                    <button type="button" class="btn btn-info btn-circle mr-2" onclick='showKanjiDetail(<%= k.to_json %>)' title="Xem chi tiết"><i class="fas fa-eye"></i></button>
                  <% end %>
                  <% if is_contribution %>
                    <%= link_to admin_kanji_path(k["id"]), class: "btn btn-primary btn-sm rounded-pill px-3 mr-2 font-weight-bold shadow-xs", title: "Duyệt" do %>
                      <i class="fas <%= status == 'PENDING' ? 'fa-clipboard-check' : 'fa-history' %>"></i> <%= status == 'PENDING' ? 'Duyệt' : 'Xem' %>
                    <% end %>
                  <% else %>
                    <%= link_to edit_admin_kanji_path(k["id"]), class: "btn btn-primary btn-circle mr-2", title: "Sửa" do %> <i class="fas fa-edit"></i> <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr><td colspan="6" class="text-center py-5 text-muted font-italic">Không tìm thấy dữ liệu.</td></tr>
        <% end %>
        </tbody>
      </table>
    </div>

    <div class="card-footer bg-white border-top py-3">
      <div class="pagination-wrapper">
        <div class="custom-pagination-bar">
          <%# ===== PREV ===== %>
          <% if @current_page > 1 %>
            <%= link_to admin_kanjis_path(page: @current_page - 1, keyword: params[:keyword], status: params[:status], created_at: params[:created_at]), class: "nav-arrow mr-2" do %>&laquo;<% end %>
          <% end %>

          <%# ===== PAGE NUMBERS ===== %>
          <%
            window = 2
            start_page = [@current_page - window, 1].max
            end_page   = [@current_page + window, @total_pages].min
          %>

          <% if start_page > 1 %>
            <%= link_to "1", admin_kanjis_path(page: 1, keyword: params[:keyword], status: params[:status], created_at: params[:created_at]), class: "mx-1" %>
            <% if start_page > 2 %><span class="mx-1 text-muted">…</span><% end %>
          <% end %>

          <% (start_page..end_page).each do |p| %>
            <% if p == @current_page %>
              <span class="mx-1 font-weight-bold text-white bg-primary px-3 py-1 rounded-pill"><%= p %></span>
            <% else %>
              <%= link_to p, admin_kanjis_path(page: p, keyword: params[:keyword], status: params[:status], created_at: params[:created_at]), class: "mx-1 px-3 py-1 rounded-pill text-primary" %>
            <% end %>
          <% end %>

          <% if end_page < @total_pages %>
            <% if end_page < @total_pages - 1 %><span class="mx-1 text-muted">…</span><% end %>
            <%= link_to @total_pages, admin_kanjis_path(page: @total_pages, keyword: params[:keyword], status: params[:status], created_at: params[:created_at]), class: "mx-1" %>
          <% end %>

          <%# ===== NEXT ===== %>
          <% if @current_page < @total_pages %>
            <%= link_to admin_kanjis_path(page: @current_page + 1, keyword: params[:keyword], status: params[:status], created_at: params[:created_at]), class: "nav-arrow ml-2" do %>&raquo;<% end %>
          <% end %>
        </div>
      </div>
    </div>

  </div> </div> <div class="modal fade" id="kanjiDetailModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-info text-white py-2">
        <h5 class="modal-title font-weight-bold"><i class="fas fa-book-open mr-2"></i>Chi tiết Kanji</h5>
        <button type="button" class="close text-white" data-dismiss="modal"><span>&times;</span></button>
      </div>
      <div class="modal-body p-4">
        <div class="row">
          <div class="col-md-4 text-center border-right">
            <h1 class="display-1 font-weight-bold text-primary mb-0" id="m_kanji"></h1>
            <h4 class="text-dark font-weight-bold text-uppercase" id="m_hanviet"></h4>
            <div id="m_jlpt_badge" class="mt-2"></div>
            <hr>
            <div id="m_image_container"></div>
            <div class="mt-3 text-left bg-light p-3 rounded">
              <div class="mb-3"><strong class="text-muted small">BỘ THỦ:</strong> <span id="m_radical" class="text-primary font-weight-bold ml-1"></span></div>
              <div class="mb-3 border-top pt-2"><strong class="text-muted small">THÀNH PHẦN:</strong> <div id="m_components" class="text-dark mt-1"></div></div>
              <div class="border-top pt-2"><strong class="text-muted small">SỐ NÉT:</strong> <span id="m_strokes" class="font-weight-bold ml-1"></span></div>
            </div>
          </div>
          <div class="col-md-8">
            <div class="mb-3"><label class="small font-weight-bold text-muted">Ý NGHĨA:</label><div id="m_meaning" class="p-2 bg-light rounded border-left border-info font-weight-bold text-dark"></div></div>
            <div class="row mb-3">
              <div class="col-6"><label class="small font-weight-bold text-danger">ÂM ON:</label><div id="m_onyomi" class="text-danger font-weight-bold"></div></div>
              <div class="col-6"><label class="small font-weight-bold text-success">ÂM KUN:</label><div id="m_kunyomi" class="text-success font-weight-bold"></div></div>
            </div>
            <div class="mb-3"><label class="small font-weight-bold text-info">CÂU CHUYỆN:</label><div id="m_story" class="font-italic text-dark pl-2" style="border-left: 3px solid #17a2b8;"></div></div>
            <div class="row">
              <div class="col-12 mb-3"><label class="small font-weight-bold text-success text-uppercase">Từ vựng:</label><div id="m_vocabulary" class="p-2 border rounded bg-white small" style="max-height: 120px; overflow-y: auto;"></div></div>
              <div class="col-12"><label class="small font-weight-bold text-primary text-uppercase">Ví dụ:</label><div id="m_examples" class="p-2 border rounded bg-white small" style="max-height: 120px; overflow-y: auto;"></div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer py-2 border-top-0">
        <button type="button" class="btn btn-secondary rounded-pill px-4" data-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script>
    function showKanjiDetail(k) {
        document.getElementById('m_kanji').innerText = k.kanji || '';
        document.getElementById('m_hanviet').innerText = k.han_viet || k.translation || '---';
        document.getElementById('m_jlpt_badge').innerHTML = `<span class="badge badge-danger px-3 shadow-sm">JLPT N${k.jlpt || '?'}</span>`;
        document.getElementById('m_meaning').innerText = k.meaning || 'Chưa cập nhật';
        document.getElementById('m_radical').innerText = k.radical || '---';
        document.getElementById('m_strokes').innerText = k.num_strokes || k.stroke_count || 0;
        document.getElementById('m_components').innerText = k.components || 'Chưa có thông tin';
        document.getElementById('m_story').innerText = k.kanji_description || k.kanji_story || 'Chưa có câu chuyện.';
        const fmtList = (t) => { if(!t) return '<i class="text-muted">Chưa có</i>'; return t.toString().split(/\n/).map(x=>x.trim()).filter(x=>x).map(x=>"• "+x).join("<br>"); };
        document.getElementById('m_vocabulary').innerHTML = fmtList(k.vocabulary);
        document.getElementById('m_examples').innerHTML = fmtList(k.examples);
        const fmtRead = (t) => t ? t.toString().split(/[|,\n]/).filter(x=>x.trim()).join("<br>") : "---";
        document.getElementById('m_onyomi').innerHTML = fmtRead(k.on_pronunciation || k.onyomi);
        document.getElementById('m_kunyomi').innerHTML = fmtRead(k.kun_pronunciation || k.kunyomi);
        const imgDiv = document.getElementById('m_image_container');
        imgDiv.innerHTML = k.writing_image_url ? `<img src="${k.writing_image_url}" class="img-thumbnail shadow-xs" style="width:100px">` : '<div class="text-muted border p-2 small">No Image</div>';
        $('#kanjiDetailModal').modal('show');
    }
</script>