<div class="container-fluid py-4">
  <div class="row">

    <%# --- CỘT TRÁI: AVATAR + NÚT THAO TÁC --- %>
    <div class="col-md-4 mb-4">
      <div class="card shadow-sm border-0 text-center h-100">
        <div class="card-body">
          <img src="<%= @user['avatar_url'] %>"
               class="rounded-circle img-thumbnail mb-3 shadow-sm"
               style="width: 150px; height: 150px; object-fit: cover;"
               onerror="this.src='https://ui-avatars.com/api/?name=<%= @user['name'] %>'">

          <h4 class="font-weight-bold mb-1"><%= @user['name'] %></h4>
          <p class="text-muted mb-2">@<%= @user['username'] %></p>

          <span class="badge badge-warning px-3 py-2 text-white mb-3">
            <i class="fas fa-crown mr-1"></i> <%= @user['rank'] || 'BRONZE' %>
          </span>

          <hr>

          <div class="d-flex justify-content-center gap-2">
            <%= link_to edit_admin_user_path(@user['id']), class: "btn btn-primary btn-sm px-4 mr-2" do %>
              <i class="fas fa-edit"></i> Chỉnh sửa
            <% end %>

            <%# --- [FIX LỖI CRASH: KHÔNG DÙNG .to_i TRÊN BIẾN BOOLEAN] --- %>
            <%
              # Chuyển thẳng về chuỗi để so sánh (An toàn với cả true, false, 0, 1)
              raw_active = @user['is_active'].to_s
              is_active_check = (raw_active == 'true' || raw_active == '1')
            %>

            <% if is_active_check %>
              <%# Đang hoạt động -> Hiện nút KHÓA %>
              <%= button_to admin_user_path(@user['id']), method: :delete, class: "btn btn-outline-danger btn-sm px-3", data: { confirm: 'Bạn muốn KHÓA tài khoản này? User sẽ không thể đăng nhập.' } do %>
                <i class="fas fa-lock"></i> Khóa
              <% end %>
            <% else %>
              <%# Đang bị khóa -> Hiện nút MỞ KHÓA %>
              <%= button_to admin_user_path(@user['id']),
                            method: :put,
                            params: { user: { is_active: true } },
                            class: "btn btn-outline-success btn-sm px-3",
                            data: { confirm: 'Mở khóa lại cho thành viên này?' } do %>
                <i class="fas fa-lock-open"></i> Mở khóa
              <% end %>
            <% end %>
            <%# ---------------------------------------------- %>
          </div>
        </div>
      </div>
    </div>

    <%# --- CỘT PHẢI: THÔNG TIN CHI TIẾT --- %>
    <div class="col-md-8">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-white font-weight-bold text-uppercase text-muted border-bottom">
          Thông tin chi tiết
        </div>
        <div class="card-body">
          <table class="table table-borderless">
            <tbody>
            <tr>
              <th width="30%" class="text-muted">ID:</th>
              <td class="font-weight-bold">#<%= @user['id'] %></td>
            </tr>
            <tr>
              <th class="text-muted">Email:</th>
              <td><%= @user['email'] %></td>
            </tr>
            <tr>
              <th class="text-muted">Số điện thoại:</th>
              <td><%= @user['phone_number'] %></td>
            </tr>
            <tr>
              <th class="text-muted">Vai trò:</th>
              <td><%= @user['role'] == 1 ? 'Quản trị viên (Admin)' : 'Thành viên (Member)' %></td>
            </tr>
            <tr>
              <th class="text-muted">Ngày tham gia:</th>
              <td>
                <% if @user['create_by'].present? %>
                  <%= Time.parse(@user['create_by'].to_s).strftime("%d/%m/%Y - %H:%M") rescue "---" %>
                <% else %>
                  <span class="text-muted font-italic">Chưa có dữ liệu</span>
                <% end %>
              </td>
            </tr>

            <tr class="border-top">
              <th class="text-muted align-middle pt-3">Xác thực tài khoản:</th>
              <td class="pt-3">

                <%# --- [FIX LOGIC XÁC THỰC: DÙNG .to_s] --- %>
                <%
                  raw_verified = @user['is_verified'].to_s
                  is_verified_check = (raw_verified == 'true' || raw_verified == '1')
                %>

                <% if is_verified_check %>
                    <span class="text-success font-weight-bold">
                      <i class="fas fa-check-circle"></i> Đã xác thực
                    </span>
                <% else %>
                  <div class="d-flex align-items-center">
                      <span class="text-danger mr-3 font-weight-bold">
                        <i class="fas fa-times-circle"></i> Chưa xác thực
                      </span>

                    <%# Form xác thực nhanh %>
                    <%= form_with model: [:admin, User.new], url: admin_user_path(@user['id']), method: :put, local: true do |f| %>

                      <%# Gửi giá trị true để kích hoạt %>
                      <input type="hidden" name="user[is_verified]" value="true">

                      <button type="submit" class="btn btn-sm btn-outline-success shadow-sm">
                        <i class="fas fa-check"></i> Kích hoạt ngay
                      </button>
                    <% end %>
                  </div>
                <% end %>
                <%# ---------------------------------------- %>

              </td>
            </tr>

            </tbody>
          </table>
        </div>
        <div class="card-footer bg-white text-end">
          <%= link_to "Quay lại danh sách", admin_users_path, class: "btn btn-light border" %>
        </div>
      </div>
    </div>
  </div>
</div>